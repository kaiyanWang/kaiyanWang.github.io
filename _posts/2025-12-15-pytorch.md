---
layout: article
title: 深度学习框架pytorch
tags: deeplearning
cover: /assets/images/axure/page-single.jpg
---

[pytorch官方教程](https://docs.pytorch.org/tutorials/)

<!--more-->
# 环境搭建

`Conda`（Anaconda公司的包管理器）相比于`pip`（python官方的包管理器）的好处：
- Conda可以创建多个独立虚拟环境，避免版本冲突（pip本身没有环境管理功能，需要搭配venv使用，而Conda将环境管理和包管理集成在同一工具中，操作更加简洁）；
- pip只能管理Python包，无法处理深度学习框架依赖的非Python组件，如CUDA运行库，OpenCV的C++底层库，而Conda可以

`Pytorch`：深度学习框架

### 本地环境配置

第一步：安装Anaconda

第二步：创建虚拟环境
```bash
conda create -n py310 python=3.10  # 创建虚拟环境py310
conda activate py310  # 进入虚拟环境py310
```

第三步：搭建深度学习框架pytorch：查看是否有NVIDIA显卡，并到Pytorch官网下载对应的pytorch-cpu或pytorch-gpu版本（用nvidia-smi查看最高可支持的CUDA版本）[官方文档](https://pytorch.org)

注意：过去在安装pytorch时，通常需要先手动安装CUDA工具包和cuDNN（CUDA即统一计算设备架构，简单说，CUDA 是打通 “CPU 指挥 GPU 干活” 的桥梁，也是让 NVIDIA 显卡从 “只用来玩游戏 / 渲染” 变成 “能做高性能计算” 的核心工具。cuDNN是CUDA的扩展库），但是从pytorch1.0开始，自带了CUDA运行库，不需要手动安装

测试
```python
ipython
import torch
torch.cuda.is_available()  # 输出true
```

第四步：pycharm中使用存在的conda环境：anaconda/Scripts/conda.exe加载环境，选择py310；vscode中下载python和jupyter插件，选择py310环境

### 云服务器环境配置
ssh到云服务器后配置tmux和vim
```bash
scp -P 32579 .bashrc .tmux.conf .vimrc featurize@workspace.featurize.cn:
```
AutoDL平台需要自己下载tmux，并且终端不能识别conda命令，可以在.bash中添加：source "/root/miniconda3/etc/profile.d/conda.sh"

创建虚拟环境
```bash
conda create -n py38 python=3.8  # 创建虚拟环境py38
conda activate py38  # 进入虚拟环境py38
```

安装想要的pytorch版本，[官方文档](https://pytorch.org)
```bash
conda install pytorch==1.13.1 torchvision==0.14.1 torchaudio==0.13.1 pytorch-cuda=11.6 -c pytorch -c nvidia
```

使用本地IDE远程调试
```bash
conda activate py38
which python  # 得到创建的虚拟环境的python解释器位置
```

### 常用的conda命令

虚拟环境管理
```bash
# 查看所有虚拟环境
conda env list  # 查看所有虚拟环境
conda create -n env_name python=3.10  # 创建虚拟环境env_name
conda activate env_name  # 激活虚拟环境env_name
conda env remove -n env_name  # 删除虚拟环境env_name
conda create -n new_env --clone old_env  # 基于old_env创建new_env
```

包管理
```bash
conda list  # 查看当前激活环境的包
conda install numpy=1.24  # 安装到当前环境
conda update numpy  # 更新指定包
conda update --all  # 更新当前环境所有包
conda update conda  # 更新conda自身
conda remove numpy  # 当前环境卸载
conda search tensorflow  # 搜索可用的tensorflow版本
```

配置与其他常用命令
```bash
conda --version  # 查看conda版本
conda env export > environment.yml  # 导出当前环境到yaml文件（分享/备份）
conda env create -f environment.yml  # 从yaml文件创建环境（一键复现）
```

# torch包、torchvision包的使用

[网址](https://docs.pytorch.org/tutorials/beginner/basics/intro.html)

### `dir()`和`help()`函数
`dir(torch)`能输出torch包下所有的包和文件，`help()`输出使用说明

### jupyter
打开终端
```bash
jupyter notebook  # 打开jupyter notebook
jupyter lab  # 打开jupyter lab
```

### Dataset
```python
from torch.utils.data import Dataset
import os
from PIL import Image


class MyData(Dataset):
    def __init__(self, root_dir, label_name):
        super().__init__()
        self.root_dir = root_dir  # hymenoptera_data/train/
        self.label_name = label_name  # ants
        self.path = os.path.join(self.root_dir, self.label_name)  # hymenoptera_data/train/ants/
        self.img_list = os.listdir(self.path)  # 1.jpg, 2.jpg, ...

    def __len__(self):
        return len(self.img_list)

    def __getitem__(self, idx):
        img_name = self.img_list[idx]
        img_item_path = os.path.join(self.path, img_name)
        img = Image.open(img_item_path)
        label = self.label_name
        return img, label


ants_dataset = MyData("hymenoptera_data/train/", "ants")
bees_dataset = MyData("hymenoptera_data/train/", "bees")

train_dataset = ants_dataset + bees_dataset
```


### tensorboard
```python
from torch.utils.tensorboard import SummaryWriter
import numpy as np
from PIL import Image


writer = SummaryWriter("logs")
image_path = "hymenoptera_data/train/ants/0013035.jpg"
img_PIL = Image.open(image_path)
img_array = np.array(img_PIL)

writer.add_image("test", img_array, 1, dataformats='HWC')
for i in range(100):
    writer.add_scalar("y=2x", 2 * i, i)

writer.close()
```
打开终端，输入
```bash
tensorboard --logdir=logs --port=自定义端口号  # logdir=事件文件所在文件夹名
```

### transforms



# 标准流程

### 数据准备（Data Loading）：Dataset和DataLoader

### 模型搭建（Model Building）

### 损失函数（Loss Function）：分类问题用交叉熵损失（CrossEntropyLoss），回归问题用均方误差损失（MSELoss）

### 优化器（Optimizer）：Adam优化器。optimizer.zero_grad()，optimizer_backward()，optimizer.step()

### 训练循环（Training Loop）：写个for循环，把上面四个步骤串起来


