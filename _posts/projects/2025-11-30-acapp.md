---
title: 基于Django + Vue + APP的术士之战游戏
tags: Project
cover: /assets/images/axure/page-single.jpg
category: Django
---


支持在线联机对战的简易版吃鸡游戏，前后端分离，前端支持APP端和Web端。技术栈：Django，WebSocket，微服务，Vue，Redis，nginx。代码编写在云服务终端完成

功能包括：
- 游戏菜单、游戏设置：熟悉http协议
- 存储对局信息、账户信息：熟悉数据库操作
- 在Redis中存储对局状态：熟悉内存数据库操作
- 在线聊天室、实时移动、实时放技能：熟悉websocket协议
- 在线匹配系统：熟悉thrift和微服务
- 配置nginx：熟悉nginx部署云服务

项目逻辑：通过`acapp/acapp/urls.py`的`path('', include('game.urls.index'))`，找到`acapp/game/urls/index.py`，通过该文件中的
`from game.views.index import index`，`path("", index, name="index")`找到`acapp/game/views/index.py`的`index`函数：
```python
def index(request):                                                                              
    return render(request, "multiends/web.html") 
```
把`请求`、`web.html`结合，生成完整的 HTML 页面并返回给浏览器：

找到`acapp/game/templates/multiends/web.html`，该文件引入了`acapp/game/static/js/dist/game.js`（/acapp/scripts/compress_game_js.sh脚本将js/src/下的js文件打包得到一个js/dist/game.js文件，减少http请求js文件的数量）

通过`game.js`渲染`web.html`，看到前端页面。

<!--more-->

### Docker环境配置

购买云服务后，新建用户wky，并配置别名wkyserver和免密登录，将django_lesson_1_0.tar传到云服务器（具体见租云服务器及配置Docker环境）
```bash
docker load -i django_lesson_1_0.tar
docker run -p 20000:22 -p 8000:8000 --name django_server -itd django_lesson:1.0 # 记得开放这两个端口，20000端口用于ssh登录，8000端口用于调试
docker attach django_server
adduser wky
usermod -aG sudo wky
```
然后ctrl+p, ctrl+q挂起容器，回到云服务器层
```bash
ssh wky@localhost -p 20000  # 在云服务器层ssh连接到docker层的wky，测试20000端口是否开放
```

然后logout(ctrl+d)回到云服务器层，再logout回到本地终端

配置别名djangoserver：

```bash
cd .ssh
vim config
```

```bash
Host djangoserver
        HostName 39.99.43.230
        User wky
        port 20000
```

配置免密登录
```bash
ssh-copy-id djangoserver
```

回到本地终端：将配置文件.bashrc .vimrc .tmux.config传到djangoserver（也可以在云服务器wkyserver传，因为云服务器也传入了这些配置文件，只不过云服务没有配置别名，不能用djangoserver）

### git并创建项目

生成ssh-key，将秘钥传到github
```bash
cd
ssh-keygen
cd .ssh
cat id_rsa.pub
```

创建django项目：
```bash
django-admin startproject acapp
cd acapp
git init
git config --global user.name "kaiyanWang"
git config --global user.email "321202864@qq.com"
git remote add origin git@github.com:kaiyanWang/acapp.git
```

运行
```bash
python3 manage.py runserver 0.0.0.0:8000
```

发现报错，将云服务器ip写到allowed_hosts里（字符串形式写）：
```bash
vim acpp/setting.py
```

浏览器打开`云服务器ip:8000`，出现django页面，表示运行成功。

创建game应用
```bash
python3 manage.py startapp game
```

项目系统设计（game目录下）
- `menu`：菜单页面
- `playground`：游戏界面
- `settings`：设置界面

项目文件结构（game目录下，将views.py，urls.py，models.py删除，新建目录）
- `urls` 目录：管理路由，即链接与函数的对应关系
- `views` 目录：管理 http 函数
- `models` 目录：管理数据库数据（urls，views，models目录下都是python文件，因此要加__init__.py）
- `templates` 目录：管理html文件
- `static` 目录：管理静态文件，比如：
  - `css`：对象的格式，比如位置、长宽、颜色、背景、字体大小等
  - `js`：对象的逻辑，比如对象的创建与销毁、事件函数、移动、变色等
  - `image`：图片
  - `audio`：声音
  - ……
- `consumers` 目录：管理 websocket 函数

更改时区：在acapp/acapp/settings.py中，将TIME_ZONE改为'Asia/Shanghai'

让Django 框架识别并启用 game 应用：将acapp/game/apps.py中的GameConfig加到acapp/acapp/settings.py中的INSTALLED_APPS：'game.apps.GameConfig'

设置静态文件地址（static里存开发者文件，media存用户文件）：在acapp/acapp/settings.py添加
import os
STATIC_ROOT = os.path.join(BASE_DIR, 'static')

MEDIA_ROOT = os.path.join(BASE_DIR, 'media')
MEDIA_URL = '/media/'



图片下载方式：`wget --output-document=自定义图片名称 图片地址`
- `jquery` 库：
<link rel="stylesheet" href="https://cdn.acwing.com/static/jquery-ui-dist/jquery-ui.min.css">
<script src="https://cdn.acwing.com/static/jquery/js/jquery-3.3.1.min.js"></script>